<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitcamp.onemoaproject.dao.ContestDao">
  <resultMap type="contest" id="contestMap">
    <id column="ctstno" property="ctstNo"/>
    <result column="orgno" property="orgNo"/>
    <result column="ctgno" property="ctgNo"/>
    <result column="title" property="title"/>
    <result column="subcont" property="subCont"/>
    <result column="cdt" property="createdDate"/>
    <result column="sdate" property="sDate"/>
    <result column="edate" property="eDate"/>
    <result column="vw_cnt" property="vw_cnt"/>
    <result column="org" property="org"/>
    <result column="appl" property="appl"/>
    <result column="cont" property="cont"/>
    <result column="page" property="page"/>
    <result column="size" property="size"/>
    <result column="qual" property="qual"/>
    <result column="team" property="team"/>
    <result column="reward" property="reward"/>
    <result column="thumbnail" property="thumbNail"/>

    <!-- 조인 결과에서 같은 게시글에 대해 한 개의 회원 데이터를 담을 경우 -->
    <association property="contOrg" javaType="contestOrg">
      <id column="orgno" property="no"/>
      <result column="coname" property="orgName"/>
    </association>

    <!-- 조인 결과에서 같은 게시글에 대해 한 개의 회원 데이터를 담을 경우 -->
    <association property="contCategory" javaType="contestCategory">
      <id column="ctgno" property="no"/>
      <result column="ccname" property="categoryName"/>
    </association>

    <collection property="attachedFiles" ofType="attachedFile">
      <id column="ctstfno" property="no"/>
      <result column="fname" property="filename"/>
      <result column="fpath" property="filepath"/>
    </collection>
  </resultMap>

  <resultMap type="attachedFile" id="attachedFileMap">
    <id column="ctstfno" property="no"/>
    <result column="fname" property="filename"/>
    <result column="fpath" property="filepath"/>
    <result column="ctstno" property="boardNo"/>
  </resultMap>

  <select id="findAll" resultMap="contestMap">
    select
    ctstno,
    co.name coname,
    cc.name ccname,
    title,
    subcont,
    cdt,
    sdate,
    edate,
    vw_cnt,
    org,
    appl,
    cont,
    page,
    size,
    qual,
    team,
    reward,
    thumbnail
    from contest
    join contest_category cc on contest.ctgno = cc.ctgno
    join contest_organization co on contest.orgno = co.orgno;
  </select>

  <select id="findByNo" resultMap="contestMap">
    select
    cont.ctstno,
    co.name coname,
    cc.name ccname,
    cont.title,
    cont.subcont,
    cont.cdt,
    cont.sdate,
    cont.edate,
    cont.vw_cnt,
    cont.org,
    cont.appl,
    cont.cont,
    cont.page,
    cont.size,
    cont.qual,
    cont.team,
    cont.reward,
    cf.ctstfno,
    cf.fname,
    cf.fpath
    from
    contest cont
    join contest_category cc on cont.ctgno = cc.ctgno
    join contest_organization co on cont.orgno = co.orgno
    left outer join contest_file cf on cont.ctstno = cf.ctstno
    where
    cont.ctstno=#{value};
  </select>

  <insert id="insert" parameterType="contest"
    useGeneratedKeys="true" keyColumn="ctstno" keyProperty="ctstNo">
    INSERT INTO `contest` (`orgno`, `ctgno`, `title`, `subcont`, `sdate`, `edate`, `vw_cnt`, `org`, `appl`, `cont`, `page`, `size`, `qual`, `team`, `reward`, `thumbnail`)
    VALUES
    (
    #{orgNo},
    #{ctgNo},
    #{title},
    #{subCont},
    #{sDate},
    #{eDate},
    #{vw_cnt},
    #{org},
    #{appl},
    #{cont},
    #{page},
    #{size},
    #{qual},
    #{team},
    #{reward},
    #{thumbNail});
  </insert>

  <insert id="insertFiles" parameterType="contest">
    insert into contest_file(fname,fpath,ctstno)
    values
    <foreach collection="attachedFiles" item="file" separator=",">
      (#{file.filename},#{file.filepath},#{ctstNo})
    </foreach>
  </insert>

</mapper>